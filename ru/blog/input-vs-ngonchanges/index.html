 <!DOCTYPE html> <html lang="ru" dir="ltr"> <head> <meta name="theme-color" content="#7e52a0"> <meta name="color-scheme" content="light dark"> <meta charset="utf-8"> <meta name="author" content="Sasha Verbilo"> <title>@Input() vs ngOnChanges() {}</title> <meta name="description" content="@Input() vs ngOnChanges() {}"> <meta property="og:title" content="@Input() vs ngOnChanges() {}"> <meta property="og:type" content="website"> <meta property="og:site_name" content="sashaqred"> <meta property="og:description" content="@Input() vs ngOnChanges() {}"> <meta property="og:url" content="https://sashaqred.com/ru/blog/input-vs-ngonchanges/"> <meta name="twitter:card" content="summary"> <meta name="twitter:creator" content="@sashaqred"> <link rel="canonical" href="https://sashaqred.com/ru/blog/input-vs-ngonchanges/"> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="icon" href="/favicon.ico"> <link rel="icon" type="image/svg+xml" href="/favicon.svg"> <link rel="apple-touch-icon" href="/apple-touch-icon.png"> <link rel="stylesheet" href="/assets/style-a07a4ee7.css"> </head> <body> <header class="header"> <div class="header-wrapper"> <nav class="header-nav"> <ul> <li> <a href="/ru/" aria-current="page"> Блог </a> </li> <li> <a href="/ru/about/"> О </a> </li> </ul> </nav> <div class="system-switchers"> <ul class="lang-switcher"> <li><span>ru</span></li> <li><a href="/en/">en</a></li> </ul> <form class="theme-switcher" id="theme-form"> <label> Тема <select disabled> <option value="">Авто</option> <option value="theme-light">Светлая</option> <option value="theme-dark">Темная</option> </select> </label> </form> </div> </div> </header> <main class="page"> <div class="post"> <h1>@Input() vs ngOnChanges() {}</h1> <p> <time datetime="Wed Jan 18 2023 17:15:24 GMT+0400 (Georgia Standard Time)">18 января 2023</time> • <span>3 минуты</span> </p> <p><code class="language-">@Input()</code> vs <code class="language-">ngOnChanges() {}</code></p> <nav class="toc"> <ol><li><a href="#zachem">Зачем</a></li><li><a href="#kak">Как</a></li></ol> </nav> <ul> <li>Варианты модификации данных передаваемых в компонент</li> <li>Варианты сложения данных в компоненте <ul> <li>код в шаблоне / вызов функции в шаблоне</li> <li>pipe</li> <li>ngOnChanges</li> <li>getter</li> <li>setter</li> <li>rxjs subject</li> </ul> </li> <li>преимущества и недостатки</li> </ul> <h2 id="zachem" tabindex="-1">Зачем</h2> <p>Возможно, прежде чем отвечать на вопрос &quot;как модифицировать данные&quot;, стоит ответить на вопрос &quot;зачем их модифицировать&quot;.</p> <p>Первая причина для обработки данных — желание сэмулировать нативное поведение инпутов в angular-компоненте. Например, нативный аттрибут <code class="language-">disabled</code> можно указать несколькими способами:</p> <pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>firstDisabledInput<span class="token punctuation">"</span></span> <span class="token attr-name">disabled</span> <span class="token punctuation">/></span></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>secondDisabledInput<span class="token punctuation">"</span></span> <span class="token attr-name">disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>thirdDisabledInput<span class="token punctuation">"</span></span> <span class="token attr-name">disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>disabled<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fourthDisabledInput<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'[name="fourthDisabledInput"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre> <p>Во всех четырех случаях инпут будет задизейблен. В своем кастомном инпуте хотелось бы повторить такое html поведение, что бы конечный пользователь не ломал голову, а как правильно задизейблить кастомный инпут и работал с ним так, как он привык в других html элементах.</p> <p>Вторая причина — особенность интерполяции в angular: все что указано без квадратных скобок (<code class="language-">[]</code>) — интерпретируется как строка при передаче в инпут компонента.</p> <pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- Значение переменной внутри компонента — `'1'` --></span><br><span class="token comment">&lt;!-- Тип переменной внутри компонента — `'string'` --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-component</span> <span class="token attr-name">input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br><span class="token comment">&lt;!-- Значение переменной внутри компонента — `'1'` --></span><br><span class="token comment">&lt;!-- Тип переменной внутри компонента — `'string'` --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-component</span> <span class="token attr-name">input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br><span class="token comment">&lt;!-- Значение переменной внутри компонента — `1` --></span><br><span class="token comment">&lt;!-- Тип переменной внутри компонента — `'number'` --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-component</span> <span class="token attr-name">[input]</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br><span class="token comment">&lt;!-- Значение переменной внутри компонента — `'a'` --></span><br><span class="token comment">&lt;!-- Тип переменной внутри компонента — `'string'` --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-component</span> <span class="token attr-name">input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>a<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br><span class="token comment">&lt;!-- Значение переменной внутри компонента — значение переменной `a` приведенное к строке --></span><br><span class="token comment">&lt;!-- Тип переменной внутри компонента — `'string'` --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-component</span> <span class="token attr-name">input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br><span class="token comment">&lt;!-- Значение переменной внутри компонента — значение переменной `a` --></span><br><span class="token comment">&lt;!-- Тип переменной внутри компонента — typeof a // зависит от типа переменной `a` --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-component</span> <span class="token attr-name">[input]</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>a<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre> <p>В &quot;конечных&quot; приложениях легко контролировать то, как используются компоненты и в какой нотации в них передаются данные: можно договориться с командой или настроить линтер на использование <code class="language-">[input]=&quot;1&quot;</code> нотации. Но в случае библиотек, не всегда понятно как именно ее потребитель будет передавать данные в компоненты. К тому же в каком-то плане нотация без квадратных скобок <code class="language-">input=&quot;1&quot;</code> является нативной для веба: html элементы корректно обрабатывают такую ситауцию, например <code class="language-">&lt;textarea rows=&quot;1&quot; /&gt;</code>. А в некоторых angular-библиотеках компонентов все еще можно словить баг с классический примером <code class="language-">1 + '1' === '11'</code> из серии wtf js.</p> <p>Третья причина — необходимость скорректировать данные, пришедшие в компонент. Бывает, что в компонент приходят правильные по типу данные: строка, число, массив;, но не по смысловому значению: число, но оно дробное, а надо целое.</p> <h2 id="kak" tabindex="-1">Как</h2> <p><em>* Прежде чем мы продолжим, стоит отметить: <strong>компоненты не исправят проблемы бизнес-логики</strong>. Если в базе данных вместо целого положительного числа хранится <code class="language-">-1.25</code>, и это значение влияет на результат работы приложения, то кажется, проблема серьезнее, чем криво отрисованный пагинатор. Поэтому для упрощения, про компоненты будем говорить в контексте библиотеки компонентов на проекте, которые отвечают за отображение и больше ничего.</em></p> <p>Вариант №0 — подготовить правильные данные снаружи компонента. Хороший вариант, но как-то не юзер-френдли, если мы делаем библиотеку компонентов.</p> <p>Вариант №1 — использовать pipe. Отлично подходит, если данные нам нужны только для отображения. Передали дату в компонент, компонент в шаблон с пайпом, пайп отформатировал дату в строку и нарисовал на странице. Пайпы очень удобно переиспользовать в различных частях приложения.</p> <p>Вариант №2 — использовать геттер. Пайп работает отлично, пока он находится в шаблоне. Как только нам понадобятся данные в коде компонента, пайп нам больше не помощник. Создаем геттер, в геттере пишем логику преобразования, возвращаем результат, используем где хотим, в шаблоне компонента или в коде — без разницы.</p> <p>Приведение типа:</p> <pre class="language-ts"><code class="language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> unknownValue <span class="token operator">=</span> <span class="token string">'0'</span><span class="token punctuation">;</span><br><span class="token keyword">get</span> <span class="token function">numberValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unknownValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre> <p>Или дополнительное форматирование</p> <pre class="language-ts"><code class="language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> dateValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">get</span> <span class="token function">formattedDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dateValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre> <p>Вариант №3 — использовать сеттер. С геттером есть 1 нюанс: он будет выполняться при каждом использовании, а в шаблоне каждое использование будет еще обновляться и при каждом вызове change detection, вне зависимости от того, поменялись ли значения, на которые он полагается. Иногда это может сильно влиять на перфоманс. В таком случае данные лучше преобразовать прямо в сеттере компонента.</p> <p>Например, если мы приводим переданные данные к числу, то записать можно прямо в самого себя</p> <pre class="language-ts"><code class="language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">set</span> <span class="token function">numberValue</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>_numberValue <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token keyword">get</span> <span class="token function">numberValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_numberValue<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token keyword">private</span> _numberValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code></pre> <p>А если мы хотим оптимизировать работу геттера, который форматирует дату, то лучше для этого использовать отдельное свойство в компоненте:</p> <pre class="language-ts"><code class="language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">set</span> <span class="token function">dateValue</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>_dateValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>formattedDate <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dateValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token keyword">get</span> <span class="token function">dateValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_dateValue<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token keyword">private</span> _dateValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>formattedDate <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dateValue<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> </div> </main> <footer class="page-footer"> Построен на <a href="https://11ty.io/">Eleventy</a> / <a href="https://github.com/sashaqred/sashaqred/blob/main/./src/ru/blog/input-vs-ngonchanges/index.md">Посмотреть на GitHub</a> </footer> <script>const possibleThemes=["theme-light","theme-dark"],control=document.querySelector("#theme-form select");function changeEvent({srcElement:e}){setTheme(e.value)}function setTheme(e){possibleThemes.forEach((t=>{t===e?document.documentElement.classList.add(t):document.documentElement.classList.remove(t)})),localStorage.theme=e}function initTheme(){const e=localStorage.theme??"",t=document.querySelector("#theme-form select");t.value=e,setTheme(t.value)}control.disabled=!1,control.addEventListener("change",changeEvent),initTheme()</script> </body> </html> 